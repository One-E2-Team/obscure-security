<html>

<head>
    <script src='util.js' type='text/javascript'></script>
    <script>
        async function register() {
            let email = document.getElementById('email').value;
            let country = document.getElementById('country').value;
            let state = document.getElementById('state').value;
            let locality = document.getElementById('locality').value;
            let organization = document.getElementById('organization').value;
            let organizationalUnit = document.getElementById('organizationalUnit').value;
            let userType = document.getElementById('type').value;
            let password = document.getElementById('password').value;
            let password2 = document.getElementById('password2').value;

            if (!email || !country || !state || !locality || !organization || !organizationalUnit || !password || !password2) {
                alert('Empty input!');
                return;
            }

            if (password !== password2) {
                alert('Passwords are not same!');
                return;
            }

            let mailRegex = new RegExp('([a-zA-Z0-9]+\.?)*[a-zA-Z0-9]@[a-z0-9]+(\.[a-z]{2,3})+');
            if (!mailRegex.test(email)) {
                alert('Invalid mail!');
                return;
            }

            let passRegex = new RegExp('^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[*.!@#$%^&(){}[:;<>,.?~_+-=|])[A-Za-z0-9*.!@#$%^&(){}[:;<>,.?~_+-=|]{8,}$');
            if (!passRegex.test(password)) {
                alert('Password must contain at least one lower, one capital letter, one number and one special character!\nPassword must have at least 8 characters!');
                return;
            }

            let xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 201) {
                    alert('Account successfully created!\nCheck email for validation.');
                }
            };
            xhttp.open("POST", "/api/auth/register", true);
            xhttp.setRequestHeader("Content-type", "application/json");
            let encoder = new TextEncoder();
            let hash = await window.crypto.subtle.digest('SHA-512', encoder.encode(password));
            let hexPass = (Array.from(new Uint8Array(hash))).map(b => b.toString(16).padStart(2, '0')).join('');
            let data = {
                email: email,
                password: hexPass,
                country: country,
                state: state,
                locality: locality,
                organization: organization,
                organizationalUnit: organizationalUnit,
                userType: userType
            };
            xhttp.send(JSON.stringify(data));
        }
    </script>
</head>

<body>
    <div class="container center">
        <table>
            <tr>
                <td><label for="email">E-mail: </label></td>
                <td><input id="email" type="text" name="email" /></td>
            </tr>
            <tr>
                <td><label for="country">Country: </label></td>
                <td><input id="country" type="text" name="country" /></td>
            </tr>
            <tr>
                <td><label for="state">State: </label></td>
                <td><input id="state" type="text" name="state" /></td>
            </tr>
            <tr>
                <td><label for="locality">Locality: </label></td>
                <td><input id="locality" type="text" name="locality" /></td>
            </tr>
            <tr>
                <td><label for="organization">Organization: </label></td>
                <td><input id="organization" type="text" name="organization" /></td>
            </tr>
            <tr>
                <td><label for="organizationalUnit">Organizational unit: </label></td>
                <td><input id="organizationalUnit" type="text" name="organizationalUnit" /></td>
            </tr>
            <tr>
                <td><label for="type">User type: </label></td>
                <td><select name="type" id="type">
                        <option value="INTERMEDIARY_CA">INTERMEDIARY_CA</option>
                        <option value="END_ENTITY ">END_ENTITY</option>
                </select></td>
            </tr>
            <tr>
                <td><label for="password">Password: </label></td>
                <td><input id="password" type="password" name="password" /></td>
            </tr>
            <tr>
                <td><label for="password2">Retype password: </label></td>
                <td><input id="password2" type="password" name="password2" /></td>
            </tr>
            <tr>
                <td colspan="2" style="text-align: center;"><input type="button" onclick="register()" value="register" /></td>
            </tr>
        </table>
    </div>
</body>

</html>